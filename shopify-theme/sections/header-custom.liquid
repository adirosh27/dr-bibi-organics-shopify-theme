{% comment %}
  Custom Header for Dr. Bibi Organics
  Fully inline-styled - includes cart drawer like Vercel
{% endcomment %}

<!-- Favicon for browser tab - injected via JS since sections load in body -->
<script>
(function() {
    // Remove any existing favicons
    var existingIcons = document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"], link[rel="apple-touch-icon"]');
    existingIcons.forEach(function(icon) { icon.remove(); });

    // Add new favicon
    var favicon = document.createElement('link');
    favicon.rel = 'icon';
    favicon.type = 'image/png';
    favicon.href = 'https://cdn.shopify.com/s/files/1/0922/8068/4819/files/Bibi_logo-Venmo_007d67d2-4cab-4b38-8401-9114d5c90045.png?height=32';
    document.head.appendChild(favicon);

    // Add apple touch icon
    var appleIcon = document.createElement('link');
    appleIcon.rel = 'apple-touch-icon';
    appleIcon.href = 'https://cdn.shopify.com/s/files/1/0922/8068/4819/files/Bibi_logo-Venmo_007d67d2-4cab-4b38-8401-9114d5c90045.png?height=180';
    document.head.appendChild(appleIcon);
})();
</script>

<!-- Load Google Fonts for header -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,700&display=swap" rel="stylesheet">

<style>
/* Dropdown hover - pure CSS */
.drb-dropdown { position: relative; display: inline-block; }
.drb-dropdown-menu {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    top: 100%;
    left: -10px;
    background: white;
    min-width: 220px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    border-radius: 12px;
    padding: 8px;
    z-index: 100;
    transition: opacity 0.15s ease, visibility 0.15s ease;
}
.drb-dropdown:hover .drb-dropdown-menu {
    visibility: visible;
    opacity: 1;
}
.drb-dropdown-menu a {
    display: block;
    padding: 10px 16px;
    color: #475569;
    text-decoration: none;
    border-radius: 8px;
    transition: background 0.15s;
}
.drb-dropdown-menu a:hover {
    background: #E8EDE7;
    color: #2D5F4C;
}

/* Mobile menu hidden by default */
.drb-mobile-menu { display: none; }
.drb-mobile-menu.show { display: block; }

/* Hide desktop nav on mobile */
@media (max-width: 1023px) {
    .drb-desktop-nav { display: none !important; }
    .drb-search-desktop { display: none !important; }
    .drb-account-link { display: none !important; }
}
/* Mobile styles */
@media (max-width: 767px) {
    .drb-logo-text { font-size: 18px !important; }
    .drb-shop-now-btn { display: none !important; }
}
/* Tablet */
@media (min-width: 768px) and (max-width: 1023px) {
    .drb-logo-text { font-size: 20px !important; }
    .drb-shop-now-btn { padding: 8px 16px !important; font-size: 13px !important; }
}
@media (min-width: 768px) {
    .drb-nav-container { padding: 0 24px !important; }
    .drb-nav-container > div { height: 80px !important; }
}
@media (min-width: 1024px) {
    .drb-mobile-toggle { display: none !important; }
    .drb-logo-text { font-size: 30px !important; }
}

/* Cart drawer styles - matches Vercel */
.drb-cart-drawer {
    position: fixed;
    top: 80px;
    right: 0;
    width: 100%;
    max-width: 384px;
    max-height: calc(100vh - 80px);
    background: white;
    box-shadow: -4px 0 25px rgba(0,0,0,0.15), 0 10px 40px rgba(0,0,0,0.1);
    border-left: 1px solid rgba(45,95,76,0.1);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 9999;
    overflow-y: auto;
}
.drb-cart-drawer.open {
    transform: translateX(0);
}
.drb-cart-overlay {
    position: fixed;
    inset: 0;
    background: rgba(31,41,55,0.5);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 9998;
}
.drb-cart-overlay.open {
    opacity: 1;
    pointer-events: auto;
}
/* Shine effect for buttons */
.drb-shine {
    position: relative;
    overflow: hidden;
}
.drb-shine::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}
.drb-shine:hover::before {
    left: 100%;
}
</style>

<!-- Cart Overlay -->
<div id="drbCartOverlay" class="drb-cart-overlay" onclick="closeDrbCart()"></div>

<!-- Cart Drawer - Vercel Style -->
<div id="drbCartDrawer" class="drb-cart-drawer">
    <div style="padding: 24px;">
        <!-- Header -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
            <h3 style="font-size: 20px; font-family: 'Playfair Display', Georgia, serif; font-weight: 600; color: #2D5F4C; margin: 0;">Your Cart</h3>
            <button onclick="closeDrbCart()" style="background: none; border: none; cursor: pointer; padding: 8px; margin: -8px; color: rgba(100,116,139,0.6);">
                <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Cart Items -->
        <div id="drbCartItems" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
            <!-- Items loaded via JS -->
        </div>

        <!-- Empty State -->
        <div id="drbCartEmpty" style="text-align: center; padding: 48px 0;">
            <svg style="width: 64px; height: 64px; margin: 0 auto 16px; color: rgba(100,116,139,0.2);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
            </svg>
            <p style="color: rgba(100,116,139,0.6); margin-bottom: 16px;">Your cart is empty</p>
            <a href="#purchase" onclick="closeDrbCart()" style="display: inline-block; margin-top: 16px; color: #2D5F4C; font-weight: 500;">Start shopping</a>
        </div>

        <!-- Footer -->
        <div id="drbCartFooter" style="border-top: 1px solid #C4D5CC; padding-top: 16px; display: none;">
            <!-- Discounts display -->
            <div id="drbCartDiscounts"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <span style="font-weight: 600; color: #2D5F4C;">Total:</span>
                <span id="drbCartTotal" style="font-size: 24px; font-family: 'Playfair Display', Georgia, serif; font-weight: 600; color: #2D5F4C;">$0.00</span>
            </div>
            <a href="/checkout" class="drb-shine" style="display: block; width: 100%; background: linear-gradient(to right, #2D5F4C, #1A3A2E); color: white; padding: 12px; border-radius: 9999px; font-weight: 600; text-align: center; text-decoration: none; margin-bottom: 12px; box-sizing: border-box;">
                Proceed to Checkout
            </a>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button onclick="closeDrbCart()" style="flex: 1; border: 2px solid #C4D5CC; background: white; color: #2D5F4F; padding: 8px; border-radius: 9999px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Continue Shopping
                </button>
                <button onclick="clearDrbCart()" style="flex: 1; border: 2px solid #FECACA; background: white; color: #DC2626; padding: 8px; border-radius: 9999px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Clear Cart
                </button>
            </div>
            <p style="font-size: 12px; text-align: center; color: rgba(100,116,139,0.6);">Free shipping and expedited shipping available</p>
        </div>
    </div>
</div>

<!-- Navigation -->
<nav class="drb-nav" style="background: rgba(255,254,249,0.97); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); position: fixed; width: 100%; top: 0; left: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
    <div class="drb-nav-container" style="max-width: 1280px; margin: 0 auto; padding: 0 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; height: 70px;">

            <!-- Logo -->
            <div style="flex-shrink: 0;">
                <a href="/" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                    {% if section.settings.logo != blank %}
                    <img src="{{ section.settings.logo | image_url: height: 40 }}"
                         alt="{{ shop.name }}"
                         style="height: 40px;"
                         loading="eager">
                    {% else %}
                    <img src="https://drbibiorganics.com/cdn/shop/files/Bibi_logo-Venmo_007d67d2-4cab-4b38-8401-9114d5c90045.png?height=40"
                         alt="{{ shop.name }}"
                         style="height: 40px;"
                         loading="eager">
                    {% endif %}
                    <span class="drb-logo-text" style="font-size: 24px; font-family: 'Playfair Display', serif; font-weight: 700; letter-spacing: -0.025em; color: #2D5F4C;">
                        Dr. Bibi Organics
                    </span>
                </a>
            </div>

            <!-- Desktop Navigation -->
            <div class="drb-desktop-nav" style="display: flex; align-items: center; gap: 32px;">

                <!-- Shop Dropdown -->
                <div class="drb-dropdown">
                    <span style="font-size: 14px; font-weight: 600; color: #475569; cursor: pointer; padding: 8px 0; display: inline-block;">
                        Shop ‚ñæ
                    </span>
                    <div class="drb-dropdown-menu">
                        <a href="/products/butter-oasis-moisturizing-balm">Butter Oasis Balm</a>
                        <a href="/products/butter-oasis-moisturizing-balm#bundles">Bundles & Save</a>
                        <a href="/collections/all">All Products</a>
                    </div>
                </div>

                <!-- About Dropdown -->
                <div class="drb-dropdown">
                    <span style="font-size: 14px; font-weight: 600; color: #475569; cursor: pointer; padding: 8px 0; display: inline-block;">
                        About ‚ñæ
                    </span>
                    <div class="drb-dropdown-menu">
                        <a href="/#story">Our Story</a>
                        <a href="/#benefits">Benefits</a>
                        <a href="/#ingredients">Ingredients</a>
                        <a href="/#reviews">Reviews</a>
                    </div>
                </div>

                <!-- Resources Dropdown -->
                <div class="drb-dropdown">
                    <span style="font-size: 14px; font-weight: 600; color: #475569; cursor: pointer; padding: 8px 0; display: inline-block;">
                        Resources ‚ñæ
                    </span>
                    <div class="drb-dropdown-menu">
                        <a href="/pages/dr-bibis-curated-resources">Skincare</a>
                        <a href="/pages/faqs">FAQs</a>
                        <a href="/pages/contact">Contact Us</a>
                        <a href="/policies/refund-policy">Returns & Refunds</a>
                        <a href="/policies/terms-of-service">Terms of Service</a>
                    </div>
                </div>
            </div>

            <!-- Right Side Actions -->
            <div style="display: flex; align-items: center; gap: 12px;">

                <!-- Search Bar - Desktop -->
                <div class="drb-search-desktop" style="position: relative;">
                    <form action="/search" method="get" style="display: flex; align-items: center;">
                        <input type="search"
                               name="q"
                               placeholder="Search..."
                               style="width: 160px; padding: 8px 40px 8px 16px; border-radius: 9999px; border: 1px solid #E8EDE7; font-size: 14px; outline: none; background: white;">
                        <button type="submit" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 0;">
                            <svg style="width: 16px; height: 16px; color: #2D5F4C;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- Account Link - Desktop -->
                <a href="/account" class="drb-account-link" style="color: #475569; text-decoration: none;">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </a>

                <!-- Cart Icon - Opens Drawer -->
                <button onclick="openDrbCart()" style="position: relative; color: #1F1F1F; background: none; border: none; cursor: pointer; padding: 4px;">
                    <svg style="width: 22px; height: 22px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                    </svg>
                    <span id="drbCartCount" style="position: absolute; top: -4px; right: -4px; background: #2D5F4C; color: white; font-size: 11px; border-radius: 50%; width: 18px; height: 18px; display: {% if cart.item_count > 0 %}flex{% else %}none{% endif %}; align-items: center; justify-content: center; font-weight: 600;">
                        {{ cart.item_count }}
                    </span>
                </button>

                <!-- Shop Now CTA -->
                <a href="/products/butter-oasis-moisturizing-balm" class="drb-shop-now-btn" style="background: linear-gradient(to right, #2D5F4C, #1A3A2E); color: white; padding: 10px 20px; border-radius: 9999px; font-size: 14px; font-weight: 600; text-decoration: none; white-space: nowrap; box-shadow: 0 2px 8px rgba(45,95,76,0.3);">
                    Shop Now
                </a>

                <!-- Mobile Menu Button -->
                <button class="drb-mobile-toggle" onclick="document.getElementById('drb-mobile-menu').classList.toggle('show')" style="padding: 8px; background: none; border: none; cursor: pointer;">
                    <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="drb-mobile-menu" class="drb-mobile-menu" style="background: white; border-top: 1px solid #E8EDE7; padding: 16px 24px;">
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <a href="/products/butter-oasis-moisturizing-balm" style="font-size: 16px; font-weight: 600; color: #1A3A2E; text-decoration: none;">Shop</a>
            <a href="/#story" style="font-size: 16px; font-weight: 600; color: #1A3A2E; text-decoration: none;">Our Story</a>
            <a href="/#benefits" style="font-size: 16px; font-weight: 600; color: #1A3A2E; text-decoration: none;">Benefits</a>
            <a href="/#ingredients" style="font-size: 16px; font-weight: 600; color: #1A3A2E; text-decoration: none;">Ingredients</a>
            <a href="/pages/faqs" style="font-size: 16px; font-weight: 600; color: #1A3A2E; text-decoration: none;">FAQs</a>
            <a href="/pages/contact" style="font-size: 16px; font-weight: 600; color: #1A3A2E; text-decoration: none;">Contact</a>
            <form action="/search" method="get" style="padding-top: 16px; border-top: 1px solid #E8EDE7;">
                <input type="search" name="q" placeholder="Search..." style="width: 100%; padding: 10px 16px; border-radius: 9999px; border: 1px solid #E8EDE7; font-size: 14px;">
            </form>
        </div>
    </div>
</nav>

<!-- Spacer for fixed nav -->
<div class="drb-nav-spacer" style="height: 70px;"></div>
<style>
@media (min-width: 768px) {
    .drb-nav-spacer { height: 80px !important; }
}
</style>

<script>
// Cart Drawer Functions
function openDrbCart() {
    document.getElementById('drbCartDrawer').classList.add('open');
    document.getElementById('drbCartOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
    refreshDrbCart();
}

function closeDrbCart() {
    document.getElementById('drbCartDrawer').classList.remove('open');
    document.getElementById('drbCartOverlay').classList.remove('open');
    document.body.style.overflow = '';
}

// Refresh cart contents
async function refreshDrbCart() {
    try {
        const response = await fetch('/cart.js');
        const cart = await response.json();
        renderDrbCart(cart);
    } catch (error) {
        console.error('Error fetching cart:', error);
    }
}

// Render cart items - Vercel style
function renderDrbCart(cart) {
    const cartItems = document.getElementById('drbCartItems');
    const cartEmpty = document.getElementById('drbCartEmpty');
    const cartFooter = document.getElementById('drbCartFooter');
    const cartTotal = document.getElementById('drbCartTotal');
    const cartCount = document.getElementById('drbCartCount');

    // Update cart count badge
    if (cart.item_count > 0) {
        cartCount.textContent = cart.item_count;
        cartCount.style.display = 'flex';
    } else {
        cartCount.style.display = 'none';
    }

    if (cart.item_count === 0) {
        cartItems.style.display = 'none';
        cartEmpty.style.display = 'block';
        cartFooter.style.display = 'none';
        return;
    }

    cartItems.style.display = 'flex';
    cartEmpty.style.display = 'none';
    cartFooter.style.display = 'block';

    cartItems.innerHTML = cart.items.map(item => {
        const originalLinePrice = item.original_line_price / 100;
        const finalLinePrice = item.final_line_price / 100;
        const hasDiscount = item.original_line_price > item.final_line_price;

        return `
        <div style="display: flex; gap: 16px; background: rgba(196,213,204,0.2); padding: 16px; border-radius: 12px;">
            <img src="${item.image}" alt="${item.title}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
            <div style="flex: 1; min-width: 0;">
                <h4 style="font-weight: 600; color: #1F2937; font-size: 14px; margin-bottom: 4px;">${item.product_title}</h4>
                ${item.variant_title ? `<p style="font-size: 12px; color: rgba(31,41,55,0.5); margin-bottom: 4px;">${item.variant_title}</p>` : ''}
                <p style="font-size: 14px; color: rgba(31,41,55,0.6); margin-bottom: 8px;">$${(item.final_price / 100).toFixed(2)} each</p>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="drb-cart-qty-btn" data-key="${item.key}" data-action="decrease" data-qty="${item.quantity - 1}" style="width: 24px; height: 24px; border: 1px solid #C4D5CC; border-radius: 4px; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">‚àí</button>
                    <span style="font-weight: 500; font-size: 14px; min-width: 24px; text-align: center;">${item.quantity}</span>
                    <button class="drb-cart-qty-btn" data-key="${item.key}" data-action="increase" data-qty="${item.quantity + 1}" style="width: 24px; height: 24px; border: 1px solid #C4D5CC; border-radius: 4px; background: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">+</button>
                    <button class="drb-cart-qty-btn" data-key="${item.key}" data-action="remove" data-qty="0" style="margin-left: auto; background: none; border: none; cursor: pointer; color: rgba(31,41,55,0.6); font-size: 12px;">Remove</button>
                </div>
            </div>
            <div style="text-align: right;">
                ${hasDiscount ? `<p style="font-size: 12px; color: rgba(31,41,55,0.4); text-decoration: line-through;">$${originalLinePrice.toFixed(2)}</p>` : ''}
                <p style="font-weight: 600; color: ${hasDiscount ? '#2D5F4C' : '#1F2937'};">$${finalLinePrice.toFixed(2)}</p>
                ${hasDiscount ? `<p style="font-size: 11px; color: #2D5F4C; font-weight: 500;">Save $${(originalLinePrice - finalLinePrice).toFixed(2)}</p>` : ''}
            </div>
        </div>
    `}).join('');

    // Show cart discounts if any
    let discountHtml = '';
    if (cart.cart_level_discount_applications && cart.cart_level_discount_applications.length > 0) {
        discountHtml = cart.cart_level_discount_applications.map(discount => `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px 12px; background: rgba(45,95,76,0.1); border-radius: 8px;">
                <span style="font-size: 13px; color: #2D5F4C; font-weight: 500;">üè∑Ô∏è ${discount.title}</span>
                <span style="font-size: 13px; color: #2D5F4C; font-weight: 600;">-$${(discount.total_allocated_amount / 100).toFixed(2)}</span>
            </div>
        `).join('');
    }

    // Update total display with discounts
    const totalDiscount = cart.total_discount / 100;
    const originalTotal = (cart.total_price + cart.total_discount) / 100;
    const finalTotal = cart.total_price / 100;

    let totalHtml = '';
    if (totalDiscount > 0) {
        totalHtml = `
            ${discountHtml}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="color: rgba(31,41,55,0.6);">Subtotal:</span>
                <span style="text-decoration: line-through; color: rgba(31,41,55,0.4);">$${originalTotal.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="color: #2D5F4C; font-weight: 500;">You save:</span>
                <span style="color: #2D5F4C; font-weight: 600;">$${totalDiscount.toFixed(2)}</span>
            </div>
        `;
    }

    document.getElementById('drbCartDiscounts').innerHTML = totalHtml;
    cartTotal.textContent = '$' + finalTotal.toFixed(2);
}

// Update cart item
async function updateDrbCart(key, quantity) {
    try {
        const response = await fetch('/cart/change.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: key, quantity: quantity })
        });
        const cart = await response.json();
        renderDrbCart(cart);
    } catch (error) {
        console.error('Error updating cart:', error);
    }
}

// Clear entire cart
async function clearDrbCart() {
    if (!confirm('Are you sure you want to clear your cart?')) return;

    try {
        const response = await fetch('/cart/clear.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const cart = await response.json();
        renderDrbCart(cart);
    } catch (error) {
        console.error('Error clearing cart:', error);
    }
}

// Event delegation for cart drawer quantity buttons
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.drb-cart-qty-btn');
    if (btn) {
        e.preventDefault();
        const key = btn.getAttribute('data-key');
        const qty = parseInt(btn.getAttribute('data-qty'), 10);
        if (key !== null && !isNaN(qty)) {
            updateDrbCart(key, qty);
        }
    }
});

// Make functions globally available for product pages
window.openDrbCart = openDrbCart;
window.closeDrbCart = closeDrbCart;
window.refreshDrbCart = refreshDrbCart;
window.clearDrbCart = clearDrbCart;
</script>

{% schema %}
{
  "name": "Header Custom",
  "tag": "section",
  "class": "header-custom",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    }
  ]
}
{% endschema %}
